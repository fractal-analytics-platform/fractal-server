0. This error is now not reproducible with sqlite db

1. The hanging statement is the drop_all one, as in the pg shell

2. Only bg task with async db fails, both using anext and async for

3. The single test file works, the following combination hangs
poetry run pytest -v --full-trace -s tests/test_full_workflow.py::test_full_workflow[local] tests/test_background_tasks.py

4. Replacing State.get with new_db.execute("SELECT * from state") does not solve the hanging issue.

5. Adding enginge.dispose() at the end of db_create_tables does not solve the hanging issue.




$ psql -U fractal -h /var/run/postgresql -d postgres
psql (14.7 (Ubuntu 14.7-0ubuntu0.22.04.1))
Type "help" for help.

postgres=# drop database fractal_test;
ERROR:  database "fractal_test" is being accessed by other users
DETAIL:  There are 5 other sessions using the database.




datid |   datname    |  pid  | leader_pid | usesysid | usename  | application_name | client_addr | client_hostname | client_port |         backend_start         |          xact_start           |          query_start          |         state_change          | wait_event_type |     wait_event      |        state        | backend_xid | backend_xmin | query_id |              query              |         backend_type
-------+--------------+-------+------------+----------+----------+------------------+-------------+-----------------+-------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-----------------+---------------------+---------------------+-------------+--------------+----------+---------------------------------+------------------------------
       |              | 63601 |            |          |          |                  |             |                 |             | 2023-05-05 12:22:10.241507+02 |                               |                               |                               | Activity        | AutoVacuumMain      |                     |             |              |          |                                 | autovacuum launcher
       |              | 63603 |            |       10 | postgres |                  |             |                 |             | 2023-05-05 12:22:10.242013+02 |                               |                               |                               | Activity        | LogicalLauncherMain |                     |             |              |          |                                 | logical replication launcher
 13799 | postgres     | 63669 |            |    16384 | fractal  | psql             |             |                 |          -1 | 2023-05-05 12:22:29.707376+02 | 2023-05-05 12:24:19.741066+02 | 2023-05-05 12:24:19.741066+02 | 2023-05-05 12:24:19.741068+02 |                 |                     | active              |             |        14252 |          | SELECT * FROM pg_stat_activity; | client backend
 92352 | fractal_test | 63729 |            |    16384 | fractal  |                  | 127.0.0.1   |                 |       53104 | 2023-05-05 12:22:35.494816+02 | 2023-05-05 12:22:35.565575+02 | 2023-05-05 12:22:35.572266+02 | 2023-05-05 12:22:35.572267+02 | Lock            | relation            | active              |       14252 |        14252 |          |                                +| client backend
       |              |       |            |          |          |                  |             |                 |             |                               |                               |                               |                               |                 |                     |                     |             |              |          | DROP TABLE state                |
 92352 | fractal_test | 63714 |            |    16384 | fractal  |                  | 127.0.0.1   |                 |       53070 | 2023-05-05 12:22:34.455074+02 |                               | 2023-05-05 12:22:35.444495+02 | 2023-05-05 12:22:35.444567+02 | Client          | ClientRead          | idle                |             |              |          | ROLLBACK;                       | client backend
 92352 | fractal_test | 63719 |            |    16384 | fractal  |                  | 127.0.0.1   |                 |       53096 | 2023-05-05 12:22:34.661073+02 |                               | 2023-05-05 12:22:35.383946+02 | 2023-05-05 12:22:35.384026+02 | Client          | ClientRead          | idle                |             |              |          | ROLLBACK;                       | client backend
 92352 | fractal_test | 63717 |            |    16384 | fractal  |                  | 127.0.0.1   |                 |       53072 | 2023-05-05 12:22:34.660616+02 | 2023-05-05 12:22:35.552738+02 | 2023-05-05 12:22:35.554196+02 | 2023-05-05 12:22:35.554206+02 | Client          | ClientRead          | idle in transaction |             |        14252 |          | SELECT * FROM state;            | client backend
 92352 | fractal_test | 63718 |            |    16384 | fractal  |                  | 127.0.0.1   |                 |       53082 | 2023-05-05 12:22:34.660907+02 |                               | 2023-05-05 12:22:35.41274+02  | 2023-05-05 12:22:35.412818+02 | Client          | ClientRead          | idle                |             |              |          | ROLLBACK;                       | client backend
       |              | 63599 |            |          |          |                  |             |                 |             | 2023-05-05 12:22:10.241037+02 |                               |                               |                               | Activity        | BgWriterHibernate   |                     |             |              |          |                                 | background writer
       |              | 63598 |            |          |          |                  |             |                 |             | 2023-05-05 12:22:10.240863+02 |                               |                               |                               | Activity        | CheckpointerMain    |                     |             |              |          |                                 | checkpointer
       |              | 63600 |            |          |          |                  |             |                 |             | 2023-05-05 12:22:10.241249+02 |                               |                               |                               | Activity        | WalWriterMain       |                     |             |              |          |                                 | walwriter
(11 rows)
